# Toolkit & rendering preferences
# Consumes the core contract, does not redefine it.
# It is optional; the system should work without this.

# --- Wayland-first Toolkits (Safe Fallback Ordering) ---
# We only apply these if the session is explicitly Wayland to avoid breaking
# rare XWayland-only sessions or fallback TTYs.
if [ "${XDG_SESSION_TYPE:-}" = "wayland" ]; then
  : "${QT_QPA_PLATFORM:=wayland}"
  : "${SDL_VIDEODRIVER:=wayland}"
  : "${MOZ_ENABLE_WAYLAND:=1}"
  : "${_JAVA_AWT_WM_NONREPARENTING:=1}"
fi

# --- Qt Configuration Providers (REQUIRED) ---
# Kvantum and qt5ct are essential for uniformity in this setup.
: "${QT_QPA_PLATFORMTHEME:=qt5ct}"
: "${QT_STYLE_OVERRIDE:=kvantum}"

# --- IPC Capability Detection (Optional Contract) ---
# This reconstructs the "server communication" guarantee that X11 had.
# If we know the desktop, we check if we can actually talk to it.

_CORE_HAS_IPC=0

if [ -n "${XDG_CURRENT_DESKTOP:-}" ]; then
  # We use 'command -v' directly for the exit code, avoiding subshells ($())
  # This makes the check significantly faster in tight loops.
  case "${XDG_CURRENT_DESKTOP}" in
    sway|Sway)      command -v swaymsg >/dev/null 2>&1 && _CORE_HAS_IPC=1 ;;
    Hyprland)       command -v hyprctl >/dev/null 2>&1 && _CORE_HAS_IPC=1 ;;
    river)          command -v riverctl >/dev/null 2>&1 && _CORE_HAS_IPC=1 ;;
    # Add other compositors here as needed (e.g., wayfire -> wayfire-ctl)
  esac
fi

# --- Optional XDG_CURRENT_DESKTOP Inheritance & Fallback ---
# Strategy:
# A. If the compositor already set it (e.g., via Hyprland/Sway internals), KEEP IT.
# B. If empty, try to detect via standard socket variables.

if [ -z "${XDG_CURRENT_DESKTOP:-}" ]; then
  # Fallback: Check for known IPC sockets if the variable is missing
  if [ -n "${SWAYSOCK:-}" ]; then
    XDG_CURRENT_DESKTOP="sway"
  elif [ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]; then
    XDG_CURRENT_DESKTOP="Hyprland"
  elif [ -n "${RIVER_SOCKET:-}" ]; then
    XDG_CURRENT_DESKTOP="river"
  elif [ -n "${WAYFIRE_SOCKET:-}" ]; then
    XDG_CURRENT_DESKTOP="wayfire"
  elif [ -n "${NIRI_SOCKET:-}" ]; then
    XDG_CURRENT_DESKTOP="niri"
  fi
fi

# --- Path Extensions ---
# Only append if strictly necessary for your specific setup
case ":${PATH}:" in
    *:"$HOME/.spicetify":*) ;;
    *) PATH="$PATH:$HOME/.spicetify" ;;
esac

# --- Exports ---
export \
  QT_QPA_PLATFORM \
  QT_QPA_PLATFORMTHEME \
  QT_STYLE_OVERRIDE \
  SDL_VIDEODRIVER \
  MOZ_ENABLE_WAYLAND \
  _JAVA_AWT_WM_NONREPARENTING \
  PATH \
  _CORE_HAS_IPC