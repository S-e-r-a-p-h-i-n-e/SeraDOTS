# SeraDOTS Core Environment
# POSIX-compliant, init-agnostic, shell-agnostic
# DO NOT TOUCH

# --- XDG Base Directories ---
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"
XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"

# --- Runtime & Session Contract (Init-Agnostic) ---

# 1. XDG_RUNTIME_DIR (Standard POSIX safety check)
if [ -z "${XDG_RUNTIME_DIR:-}" ]; then
  _uid="$(id -u 2>/dev/null)"
  if [ -n "$_uid" ] && [ -d "/run/user/$_uid" ]; then
    XDG_RUNTIME_DIR="/run/user/$_uid"
  else
        # Last resort: use a user-owned tmpdir
        XDG_RUNTIME_DIR="${TMPDIR:-/tmp}/runtime-${_uid:-0}"
        mkdir -p "$XDG_RUNTIME_DIR"
        chmod 0700 "$XDG_RUNTIME_DIR"
    fi
fi

# 2. XDG_SESSION_TYPE (Detection)
# If WAYLAND_DISPLAY is set, we are definitely on Wayland.
if [ -n "${WAYLAND_DISPLAY:-}" ]; then
  export XDG_SESSION_TYPE="wayland"
fi

# 3. Feature Flags (The "Presence" Checks)
# These allow downstream scripts (toolkits, bars, scripts) to know capabilities
# without re-running expensive 'command -v' checks.

# Reset flags
_CORE_HAS_XWAYLAND=0
_CORE_HAS_PORTAL=0

# Check for XWayland binary (agnostic of whether it's running)
if command -v Xwayland >/dev/null 2>&1; then
  _CORE_HAS_XWAYLAND=1
fi

# Check for Portal service binary
if gdbus introspect --session --dest org.freedesktop.portal.Desktop --object-path /org/freedesktop/portal/desktop --xml >/dev/null 2>&1; then
  _CORE_HAS_PORTAL=1
else
  _CORE_HAS_PORTAL=0
fi
echo $_CORE_HAS_PORTAL

# --- Core PATH (minimal, predictable) ---
PATH="$HOME/.local/bin:$PATH"

# --- State & History ---
LESSHISTFILE="${LESSHISTFILE:-/tmp/less-hist}"
PYTHON_HISTORY="$XDG_STATE_HOME/python_history"

# --- Terminfo ---
TERMINFO="$XDG_DATA_HOME/terminfo"
TERMINFO_DIRS="$XDG_DATA_HOME/terminfo:/usr/share/terminfo"

# --- Exports (contract boundary) ---
export \
  XDG_CONFIG_HOME \
  XDG_DATA_HOME \
  XDG_STATE_HOME \
  XDG_CACHE_HOME \
  PATH \
  LESSHISTFILE \
  PYTHON_HISTORY \
  TERMINFO \
  TERMINFO_DIRS \
  XDG_RUNTIME_DIR \
  XDG_SESSION_TYPE \
  _CORE_HAS_XWAYLAND \
  _CORE_HAS_PORTAL 